<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Reactive programming for service orchestration on JVM</title>
  <meta name="description" content="Reactive programming for service orchestration on JVM">
  <meta name="author" content="Ozan Gunalp">
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="../bower_components/reveal.js/css/reveal.css">
  <link rel="stylesheet" href="../bower_components/reveal.js/lib/css/zenburn.css">
  <link rel="stylesheet" href="../css/lesfurets-theme.css" id="theme">
  <link rel="stylesheet" href="../css/git-octopus-theme.css" id="octopus-theme">
  <link rel="stylesheet" href="../css/code-jooq-theme.css" id="jooq-theme">
  <script>
      if (window.location.search.match(/print-pdf/gi)) {
          var link = document.createElement('link');
          link.rel = 'stylesheet';
          link.type = 'text/css';
          link.href = '../css/print/pdf.css';
          document.getElementsByTagName('head')[0].appendChild(link);
      }
  </script>
  <!--[if lt IE 9]>
  <script src="../bower_components/reveal.js/lib/js/html5shiv.js"></script><![endif]-->
</head>
<body>
<div id="footer" class="footer show">
  <a href="https://www.lesfurets.com" target="_blank">
    <img class="logo" src="../img/logo_lesfurets_885x128_no_back.png">
  </a>
  <a class="github" href="https://github.com/lesfurets" target="_blank">https://github.com/lesfurets</a>
  <a class="twitter" href="https://twitter.com/BeastieFurets" target="_blank">@BeastieFurets</a>
  <a class="github" href="https://github.com/ozangunalp" target="_blank">https://github.com/ozangunalp</a>
  <a style="margin-right: 10px;" class="twitter" href="https://twitter.com/ozangunalp" target="_blank">@ozangunalp</a>
  <!--<img style="width:50px;vertical-align:middle;padding-left:25px" src="../img/theodo-logo-medium.png">-->
  <span style="font-family:arial;font-weight:bold;font-size:25px;vertical-align:middle">BreizhJUG</span>
</div>
<div class="reveal">
  <div class="slides">
    <!-- SECTION - INTRO -->

    <section class="flushright" data-state="background-furets">
      <h1>Reactive programming</h1>
      <h2>for service orchestration<br>on JVM</h2>
      <h3>Ozan Gunalp</h3>
    </section>

    <section class="flushleft" data-state="background-furets">
      <h3 style="color:#f07d00">Ozan GUNALP</h3>
      <ul class="flushright nodisc">
        <li>
          <a style="color:white" href="https://twitter.com/ozangunalp">twitter.com/ozangunalp</a>
        </li>
        <li>
          <a style="color:white" href="https://github.com/ozangunalp">github.com/ozangunalp</a>
        </li>
      </ul>
      <h3 style="color:#f07d00">Contributors</h3>
      <ul class="flushleft small nodisc">
        <li>Gilles Di Guglielmo</li>
      </ul>
    </section>

    <!-- SECTION - CONTEXT -->

    <section class="center" data-background="#333">
      <h2>LesFurets.com</h2>
      <ul class="white nodisc">
        <li>Insurance comparison</li>
        <li>We call web-services of more than 25 insurers to have the best prices.</li>
        <li>Image : PPS chez LesFurets.com</li>
      </ul>
    </section>

    <section class="center" data-background="#333">
      <h2>LesFurets.com</h2>
      <ul class="white nodisc">
        <li>Tomcat Blocking IO</li>
        <li>GWT RPC on Servlet</li>
      </ul>
      <p>We are far from being reactive.</p>
    </section>

    <section class="center" data-background="#333">
      <h2>Reactive Hype</h2>
      <img style="width: 75%;background-color: white" src="../img/reactive/hype_cycle.png">
      <p>Let's test this!</p>
    </section>

    <section class="center" data-background="#333">
      <h2>Service orchestrator</h2>
      <img style="width: 75%;background-color: white" src="../img/reactive/scattergather.gif">
    </section>

    <section class="center" data-background="#333">
      <h2>Service calls fail, a lot.</h2>
      <img style="width: 75%;background-color: white" src="../img/reactive/tessera.png">
    </section>

    <section class="center" data-background="#333">
      <h2>Being reactive, on Slack</h2>
      <img style="width: 75%;background-color: white" src="../img/reactive/Slack_-_LesFurets.png">
    </section>

    <!-- Eight Fallacies of distributed computing -->
    <!--<li>1.	The network is reliable</li>-->
    <!--<li>2.	Latency is zero</li>-->
    <!--<li>3.	Bandwidth is infinite</li>-->
    <!--<li>4.	The network is secure</li>-->
    <!--<li>5.	Topology doesn't change</li>-->
    <!--<li>6.	There is one administrator</li>-->
    <!--<li>7.	Transport cost is zero</li>-->
    <!--<li>8.	The network is homogeneous</li>-->
    <section class="center" data-background="#333">
      <h2>Some fallacies</h2>
      <div class="flushleft">
        <ul class="white nodisc">
            <li>The network is <strong>NOT</strong> reliable</li>
            <li>Latency is <strong>NOT</strong> zero</li>
            <li>...</li>
            <li>There is <strong>NOT</strong> one administrator</li>
        </ul>
      </div>
    </section>

    <section class="center" data-background="#333">
      <h2>How do we scale?</h2>
      <div class="code-wrapper">
      <pre>
          <code class="code java" data-trim data-noescape>
        if (executor.getActiveCount() >= POOL_SIZE) {
            throw new NoExecutorAvailable("ThreadPool buzy");
        }
          </code>
      </pre>
      </div>
      <div>
      </div>
    </section>

    <section class="center" data-background="#333">
      <h2>Clean-er code ?</h2>
      <div class="code-wrapper smaller">
      <pre>
          <code class="code java" data-trim data-noescape>
    private Map doQuotation(ResultatTarifications resultat, Control control, List products) {
        //...
        final List runnables = new ArrayList<>();
        try {
            prepareRunnables(runnables, projet, resultat, products, control, ...);
            long timeOut = control.getConnectionTimeout();
            final long startTime = System.currentTimeMillis();
            for (OrchestratorRunnable runnable : runnables) {
                // .. mapping in, web service call, mapping out
                executeRunnable(timeOut, startTime, runnable);
            }
            waitAll(startTime, getModule(), runnables, timeOut);
            logTarificationTimer(runnables, startTime);
            postTraitements(resultat);
        } catch (Throwable t) {
            LOG.error("Error occurs during tarifications " + projet.getOffreUid(), t);
        } finally {
            checkResultat(resultat);
        }
        final Map contexts = new HashMap<>();
        for (TarificationRunnable runnable : runnables) {
            contexts.put(runnable.getProvider(), runnable.getContext());
        }
        return Collections.unmodifiableMap(contexts);
    }
          </code>
      </pre>
      </div>
    </section>

    <section class="center" data-background="#333">
      <h2>Underlying problems</h2>
      <ul class="white nodisc">
        <li>Scalability : + resources ?=> + performance</li>
        <li>Maintainability : Clean code</li>
        <li>Resilience : SLA management</li>
      </ul>
    </section>

    <section class="center" data-background="#333">
      <h2>Asynchronous code</h2>
      <ul class="nodisc">
        <li>Scalability & Performance : distribute tasks to multiple resources</li>
        <li>Resilience : isolation of errors</li>
      </ul>
    </section>

    <section class="center" data-background="#333">
      <h2>Asynchronous code</h2>
      <div class="code-wrapper">
      <pre>
          <code class="code java" data-trim data-noescape>
            public String httpBlockingGet(String url);
          </code>
      </pre>
      </div>
      <div class="code-wrapper">
      <pre>
          <code class="code java" data-trim data-noescape>
            public void httpAsyncGet(String url, AsyncCallback&lt;String&gt;);
          </code>
      </pre>
      </div>
      <div class="code-wrapper">
      <pre>
          <code class="code java" data-trim data-noescape>
            public AsyncResult&lt;String&gt; httpAsyncGet(String url);
          </code>
      </pre>
      </div>
    </section>


    <section class="center" data-background="#333">
      <h2>Mastering concurrency is difficult.</h2>
      <ul class="nodisc">
        <li>Thread pool management</li>
        <li>Access to shared state</li>
        <li>Error handling</li>
        <li>Difficult to compose/coordinate async tasks</li>
        <li>Throughput management</li>
        <li>...</li>
      </ul>
    </section>

    <section class="center" data-background="#333">
      <h2>Classic solutions for asynchronous execution</h2>
      <ul class="white nodisc">
        <li>Managing threads and locks for blocking calls</li>
        <li>Message/task queues with buffering</li>
        <li>Event loops with callbacks</li>
      </ul>
    </section>

    <section class="center small" data-background="#333" data-markdown>
      <script type="text/template">
        ## Asynchronous aspects ##
        ||h1|h2|
        |--|--|--|
        |Thread management|a|b|
        |Shared state|a|b|
        |Composability|a|b|
        |Error handling|a|b|
        |Throughput management|a|b|
      </script>
    </section>

    <section class="center" data-background="#333">
      <h2>Reactive Programming</h2>
        <p>React to asyncronous data / events<br>
        Declarative flow of data transformations
        </p>
      <p>!= Reactive systms<br>
        architectural design pattenr for distributed systems
      </p>
    </section>

    <section class="center" data-background="#333">
      <h2>Reactive programming abstractions</h2>
      <ul class="white nodisc">
        <li>Promise/Future/CompletableFuture</li>
        <li>Reactive Streams</li>
      </ul>
    </section>

    <section class="center" data-background="#333">
      <h2>Futures</h2>
      <ul class="white nodisc">
        <li>CompletableFuture</li>
        <li>Represents the result of an action that may, or may not, have occurred yet.</li>
        <li></li>
      </ul>
    </section>

    <section class="center" data-background="#333">
      <h2>Streams</h2>
      <ul class="white nodisc">
        <li>Collection : iterable group of items with definite size = define data</li>
        <li>Stream = operations on a unbounded group of items = define work</li>
      </ul>
      <p>TODO : code sample, immutability</p>
    </section>

    <section class="center" data-background="#333">
      <h2>Reactive Streams</h2>
      <ul class="white nodisc">
        Définit les opérations sur un group d'evénements
        Publisher Subscriber
      </ul>
    </section>

    <section class="center" data-background="#333">
      <h2>RxJava</h2>
      <ul class="white nodisc">
        Observables + Operators + Scheduling
      </ul>
      <p>Separation of concerns</p>
    </section>

    <section class="center" data-background="#333">
      <h2>Classic Orchestrator</h2>
      <div class="code-wrapper smaller">
      <pre>
          <code class="code java" data-trim data-noescape>
    private Map doQuotation(ResultatTarifications resultat, Control control, List<CodeFormule> codeFormules) {
        //...
        final List runnables = new ArrayList<>();
        try {
            prepareRunnables(runnables, projet, resultat, codeFormules, control, ...);
            long timeOut = control.getConnectionTimeout();
            final long startTime = System.currentTimeMillis();
            for (OrchestratorRunnable runnable : runnables) {
                executeRunnable(timeOut, startTime, runnable);
            }
            waitAll(startTime, getModule(), runnables, timeOut);
            logTarificationTimer(runnables, startTime);
            postTraitements(resultat);
        } catch (Throwable t) {
            LOG.error("Error occurs during tarifications " + projet.getOffreUid(), t);
        } finally {
            checkResultat(resultat);
        }
        final Map contexts = new HashMap<>();
        for (TarificationRunnable runnable : runnables) {
            contexts.put(runnable.getProvider(), runnable.getContext());
        }
        return Collections.unmodifiableMap(contexts);
    }
          </code>
      </pre>
      </div>
    </section>

    <section class="center" data-background="#333">
      <h2>Orchestrateur parallel stream</h2>

      <div class="code-wrapper smaller">
      <pre>
          <code class="code java" data-trim data-noescape>
      List&lt;QuoteResult&gt; resultList = LongStream.range(0, 11).parallel()
      .boxed()
      .map(l -> new QuoteRequest(l, 0.0))
      .flatMap(q -> providers.stream().parallel().map(p -> p.doReceiveQuote(q)))
      .collect(Collectors.toList());
          </code>
      </pre>
      </div>
      <p>TODO : Gestion de ressources</p>
      <div class="code-wrapper smaller">
      <pre>
          <code class="code java" data-trim data-noescape>
      System.setProperty("java.util.concurrent.ForkJoinPool.common.parallelism", "10");
          </code>
      </pre>
      </div>

    </section>

    <section class="center" data-background="#333">
      <h2>Orchestrateur CompletableFuture</h2>
      <div class="code-wrapper smaller">
      <pre>
          <code class="code java" data-trim data-noescape>
                List&lt;CompletableFuture&lt;QuoteResult&gt;&gt; futures = LongStream.range(0, 11).sequential()
            .boxed()
            .map(l -> new QuoteRequest(l, 0.0))
            .flatMap(q -> providers.stream()
              .map(p -> new CompletableProvider(p, executorService))
              .map(p -> p.doReceiveQuoteAsync(q)
                          .completeOnTimeout(new QuoteResult(
                            new TimeoutException("Timeout"), q.getOfferId(), p.provider.getId()),
                              getTimeout(), TimeUnit.MILLISECONDS)
              )
            ).collect(Collectors.toList());

            CompletableFuture&lt;List&lt;QuoteResult&gt;&gt; resultList =
              CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
                .thenApply(v -> futures.stream()
                                  .map(CompletableFuture::join)
                                  .collect(toList()));

            List&lt;QuoteResult&gt; rl = resultList.get();

          </code>
      </pre>
      </div>
      <p>TODO : gestion des threads de timeout</p>
    </section>

    <section class="center" data-background="#333">
      <h2>Orchestrateur RxJava Observables</h2>
      <div class="code-wrapper smaller">
      <pre>
          <code class="code java" data-trim data-noescape>
    List&lt;Observable&lt;QuoteResult&gt;&gt; resultList = LongStream.range(0, 11)
        .boxed()
        .map(l -> new QuoteRequest(l, 0.0))
        .flatMap(q -> providers.stream()
            .map(p -> Observable.defer(() -> Observable.just(p.doReceiveQuote(q)))
                .subscribeOn(Schedulers.from(executorService))
                .timeout(getTimeout(), TimeUnit.MILLISECONDS,
                    Observable.just(new QuoteResult(
                        new TimeoutException("Timeout"), q.getOfferId(), p.getId())))))
        .collect(toList());

    Single&lt;List&lt;QuoteResult&gt;&gt; merged = Observable.merge(resultList).toList();

    List&lt;QuoteResult&gt; results = merged.blockingGet();

          </code>
      </pre>
      </div>
    </section>

    <section class="center" data-background="#333">
      <h2>Orchestrateur RxJava2 Flowable</h2>
      <div class="code-wrapper smaller">
      <pre>
          <code class="code java" data-trim data-noescape>
      List<QuoteResult> results = new ArrayList<>();
    PublishProcessor<Long> processor = PublishProcessor.create();

    Disposable subscribe = processor
        .onBackpressureBuffer(10, () -> System.out.println(Thread.currentThread().getName() + ": Buffer Overflow "),
            BackpressureOverflowStrategy.DROP_OLDEST)
        .observeOn(Schedulers.from(executorService))
        .map(l -> new QuoteRequest(l, 0.0))
        .flatMap((q) -> Flowable.fromIterable(providers)
            .flatMap(p -> Flowable.defer(() -> Flowable.just(p.doReceiveQuote(q)))
                .subscribeOn(Schedulers.from(executorService))
                .timeout(getTimeout(), TimeUnit.MILLISECONDS, Flowable.just(new QuoteResult(new
                    TimeoutException("Timeout"), q.getOfferId(), p.getId())))
            ).toList().toFlowable())
        .subscribe(results::addAll);

    Flowable.interval(getRequestFrequency(), TimeUnit.MILLISECONDS, Schedulers.io())
        .takeWhile(t -> running.get())
        .subscribe(processor);
          </code>
      </pre>
      </div>
    </section>

    <section class="center" data-background="#333">
      <h2>Scheduling</h2>
      <ul class="white nodisc">
        <li>Pool de threads séparés par backend ou global ?</li>
        <li>Buffering</li>
      </ul>
    </section>

    <section class="center" data-background="#333">
      <h2>Backpressure</h2>
      <ul class="white nodisc">
        <li>RxJava2 vs RxJava : Flowables ajoute</li>
        <li>Différentes stratégies</li>
      </ul>
    </section>

    <section class="center" data-background="#333">
      <h2>Java 9 Flow</h2>
      <ul class="white nodisc">
        <li>Publisher Subscription Subscriber</li>
        <li>Implementation de reactive-streams specification</li>
        <li>Contient très peu d'implementation</li>
      </ul>
    </section>

    <section class="center" data-background="#333">
      <h2>Best practices & Pitfalls RxJava</h2>
      <ul class="white nodisc">
        <li>Différence entre subsribeOn vs observeOn</li>
        <li>Configuration de backpressure</li>
        <li>Gestion des erreurs</li>
        <li>Creation des Observable/Flowable</li>
      </ul>
    </section>

    <section class="center" data-background="#333">
      <h2>Perspectives</h2>
      <h3>Gestion de SLA</h3>
      <ul class="white nodisc">
        <li>Choisir la taille de buffer (compension de backpressure) par backend</li>
        <li>Implementer circuit breaker</li>
      </ul>
    </section>

    <section class="center" data-background="#333">
      <h2>Reactive Book</h2>
      <img style="width: 75%;background-color: white" src="../img/reactive/lrg.jpg">
    </section>

  </div>
</div>
<script src="../bower_components/reveal.js/lib/js/head.min.js"></script>
<script src="../bower_components/reveal.js/js/reveal.js"></script>
<script>
    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,
        embedded: true,

        // Hack my remote because it send 5 events
        keyboard: {
            // Tab : nop
            9: null,
            // Page down : previous slide
            33: function () {
                if (!window.animate) {
                    window.animate = true;
                    Reveal.left();
                    setTimeout(function () {
                        window.animate = false;
                    }, 1000);
                }
            },
            // Page up : next slide
            34: function () {
                if (!window.animate) {
                    window.animate = true;
                    Reveal.right();
                    setTimeout(function () {
                        window.animate = false;
                    }, 1000);
                }
            }
        },


        //theme: 'lesfurets', // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none

        // Parallax scrolling
        // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
        // parallaxBackgroundSize: '2100px 900px',

        // Optional libraries used to extend on reveal.js
        dependencies: [
            {
                src: '../bower_components/reveal.js/lib/js/classList.js', condition: function () {
                return !document.body.classList;
            }
            },
            {
                src: '../bower_components/reveal.js/plugin/markdown/marked.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
            {
                src: '../bower_components/reveal.js/plugin/markdown/markdown.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
            {
                src: '../bower_components/reveal.js/plugin/highlight/highlight.js', async: true, callback: function () {
                hljs.initHighlightingOnLoad();
            }
            },
            {
                src: '../bower_components/reveal.js/plugin/zoom-js/zoom.js', async: true, condition: function () {
                return !!document.body.classList;
            }
            },
            {
                src: '../bower_components/reveal.js/plugin/notes/notes.js', async: true, condition: function () {
                return !!document.body.classList;
            }
            }
        ]
    });
</script>
<script src="../js/lesfurets-theme.js" async></script>
</body>
</html>
